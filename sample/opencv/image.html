<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="charset=utf-8;"/>

    <script src="../../dist/chart.js"></script>
</head>
<body >

<div id="chart"></div>

<script id="script_code">
jui.define("chart.brush.canvas.image", [ "util.math" ], function(_) {

    var ImageBrush = function () {
        // padding to size
        this.getMatrixSize = function(padding) {
            return padding + padding + 1;
        }

        // size to padding
        this.getMatrixPadding = function(size) {
            return Math.floor(size / 2);
        }

        this.getMatrixValues = function(matrix, padding, rowIndex, colIndex) {
            var values = [];

            for(var i = -padding; i <= padding; i++) {
                for(var j = -padding; j <= padding; j++) {
                    var row = matrix[rowIndex + i];

                    if(row == undefined) {
                        values.push(0);
                    } else {
                        if(row[colIndex + j] == undefined) {
                            values.push(0);
                        } else {
                            values.push(row[colIndex + j]);
                        }
                    }
                }
            }

            return values;
        }

        this.dotMatrix = function(m1, m2) {
            var sum = 0;

            for(var i = 0; i < m1.length; i++) {
                sum += (m1[i] * m2[i]);
            }

            return sum;
        }

        this.calculateConv = function(input, kernel) {
            var padding = this.getMatrixPadding(kernel.length),
                kernel = this.getMatrixValues(kernel, padding, padding, padding).reverse(),
                result = [];

            for(var i = 0; i < input.length; i++) {
                result[i] = [];

                for(var j = 0; j < input[i].length; j++) {
                    result[i][j] = this.dotMatrix(kernel, this.getMatrixValues(input, padding, i, j));
                }
            }

            return result;
        }

        this.imageDataToRGBA = function(data, width) {
            var rowIndex = 0,
                colIndex = 0,
                r = [],
                g = [],
                b = [],
                a = [];

            for(var i = 0; i < data.length; i += 4) {
                if(colIndex == width) {
                    colIndex = 0;
                    rowIndex++;
                }

                if(!r[rowIndex]) r[rowIndex] = [];
                if(!g[rowIndex]) g[rowIndex] = [];
                if(!b[rowIndex]) b[rowIndex] = [];
                if(!a[rowIndex]) a[rowIndex] = [];

                r[rowIndex].push(data[i]);
                g[rowIndex].push(data[i + 1]);
                b[rowIndex].push(data[i + 2]);
                a[rowIndex].push(data[i + 3]);

                colIndex++;
            }

            return {
                r: r,
                g: g,
                b: b,
                a: a
            }
        }

        this.updateImage = function(rgba, width, height) {
            var image = this.canvas.createImageData(width, height),
                index = 0;

            for(var i = 0; i < height; i++) {
                for(var j = 0; j < width; j++) {
                    var r = rgba.r[i][j],
                        g = rgba.g[i][j],
                        b = rgba.b[i][j],
                        a = rgba.a[i][j];

                    image.data[index] = (r < 0) ? 0 : r;
                    index++;
                    image.data[index] = (g < 0) ? 0 : g;
                    index++;
                    image.data[index] = (b < 0) ? 0 : b;
                    index++;
                    image.data[index] = a;
                    index++;
                }
            }

            this.canvas.putImageData(image, 0, 0);
        }

        this.processImage = function(kernel) {
            var width = this.axis.area("width"),
                height = this.axis.area("height"),
                image = this.canvas.getImageData(0, 0, width, height),
                obj = this.imageDataToRGBA(image.data, width);

            this.updateImage({
                r: this.calculateConv(obj.r, kernel),
                g: this.calculateConv(obj.g, kernel),
                b: this.calculateConv(obj.b, kernel),
                a: obj.a
            }, width, height);
        }

        this.draw = function() {
            this.eachData(function(img, i) {
                this.canvas.drawImage(img, 0, 0);
                this.processImage(this.brush.kernel);
            });
        }
    }

    ImageBrush.setup = function() {
        return {
            kernel: [
                [ 0, 0, 0 ],
                [ 0, 1, 0 ],
                [ 0, 0, 0 ]
            ]
        };
    }

    return ImageBrush;
}, "chart.brush.canvas.core");

jui.ready([ "chart.builder" ], function(chart) {
    var kernels = {
        "box.blur": [
            [ 1/9, 1/9, 1/9 ],
            [ 1/9, 1/9, 1/9 ],
            [ 1/9, 1/9, 1/9 ]
        ],
        "gaussian.blur1": [
            [ 1/16, 2/16, 1/16 ],
            [ 2/16, 4/16, 2/16 ],
            [ 1/16, 2/16, 1/16 ]
        ],
        "gaussian.blur2": [
            [ 1/256, 4/256, 6/256, 4/256, 1/256 ],
            [ 4/256, 16/256, 24/256, 16/256, 4/256 ],
            [ 6/256, 24/256, 36/256, 24/256, 6/256 ],
            [ 4/256, 16/256, 24/256, 16/256, 4/256 ],
            [ 1/256, 4/256, 6/256, 4/256, 1/256 ],
        ],
        "edge.detect1": [
            [ 1, 0, -1 ],
            [ 0, 0, 0 ],
            [ -1, 0, 1 ]
        ],
        "edge.detect2": [
            [ 0, 1, 0 ],
            [ 1, -4, 1 ],
            [ 0, 1, 0 ]
        ],
        "edge.detect3": [
            [ -1, -1, -1 ],
            [ -1, 8, -1 ],
            [ -1, -1, -1 ]
        ],
        "edge.enhance": [
            [ 0, 0, 0 ],
            [ -1, 1, 0 ],
            [ 0, 0, 0 ]
        ],
        "sharpen": [
            [ 0, -1, 0 ],
            [ -1, 8, -1 ],
            [ 0, -1, 0 ]
        ],
        "emboss": [
            [ -2, -1, 0 ],
            [ -1, 1, 1 ],
            [ 0, 1, 2 ]
        ]
    }

    var c = chart("#chart", {
        padding: 0,
        axis : [{
            c: {
                type: "panel"
            }
        }],
        brush : [{
            type: "canvas.image",
            kernel: kernels["emboss"]
        }],
        canvas : true,
        render : false
    });

    var img = new Image();
    img.src = 'image.png';

    img.onload = function() {
        c.setSize(img.width, img.height);
        c.axis(0).update([ img ]);
        c.render();

        img.style.display = 'none';
    };
})
</script>


</body>
</html>